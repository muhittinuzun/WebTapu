<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suriye Tapu ve Kadastro Bilgi Sistemi (TAKBİS)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: { 50: '#ecfdf5', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' },
                        slate: { 850: '#1e293b' },
                        gold: { 500: '#D4AF37', 600: '#C5A028' }
                    }
                }
            }
        }
    </script>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- JSZip & toGeoJSON (KMZ Parsing) -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body[dir="ltr"] {
            font-family: 'Inter', sans-serif;
        }

        body[dir="rtl"] {
            font-family: 'Cairo', sans-serif;
        }

        .tapu-font {
            font-family: 'Amiri', serif;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            background: #e2e8f0;
        }

        .login-pattern {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            padding: 0;
            overflow: hidden;
        }

        .leaflet-popup-content {
            margin: 0;
            width: 260px !important;
        }

        select {
            background-position: left 0.5rem center;
        }

        [dir="rtl"] select {
            background-position: right 0.5rem center;
        }

        .parchment-bg {
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            background-color: #fdfbf7;
        }

        .settings-enter-active,
        .settings-leave-active {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .settings-enter-from,
        .settings-leave-to {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }

        @keyframes scan {
            0% {
                top: 0;
                opacity: 0;
            }

            5% {
                opacity: 1;
            }

            95% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .animate-scan {
            animation: scan 3s ease-in-out infinite;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kmz-loader {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes pulse-emerald {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .pulse-loader {
            animation: pulse-emerald 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-emerald-200"
    :dir="lang === 'ar' ? 'rtl' : 'ltr'">

    <div id="app" class="h-full relative overflow-hidden flex flex-col md:flex-row">

        <!-- LOGIN SCREEN -->
        <div v-if="!isLoggedIn" class="fixed inset-0 z-[10000] flex items-center justify-center login-pattern p-4"
            :dir="lang === 'ar' ? 'rtl' : 'ltr'">
            <div class="absolute top-6 right-6 flex gap-2 z-20">
                <button @click="setLang('ar')"
                    class="px-3 py-1 rounded text-xs font-bold transition bg-emerald-600 text-white">عربي</button>
                <button @click="setLang('tr')"
                    class="px-3 py-1 rounded text-xs font-bold transition bg-slate-800 text-slate-400">TR</button>
                <button @click="setLang('en')"
                    class="px-3 py-1 rounded text-xs font-bold transition bg-slate-800 text-slate-400">EN</button>
            </div>

            <div
                class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-8 border-emerald-600 relative overflow-hidden">
                <div class="text-center mb-8 relative z-10">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Emblem_of_Syria_%282025%E2%80%93present%29.svg/2560px-Emblem_of_Syria_%282025%E2%80%93present%29.svg.png"
                        class="h-20 mx-auto mb-4 drop-shadow-md object-contain">
                    <h1 class="text-xl md:text-2xl font-bold text-slate-800">{{ t.loginSystemName }}</h1>
                    <p class="text-slate-500 text-xs md:text-sm mt-1">{{ t.loginSubtitle }}</p>
                </div>

                <form @submit.prevent="handleLogin" class="space-y-5 relative z-10">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">{{ t.lblUsername }}</label>
                        <input v-model="loginCreds.username" type="text"
                            class="w-full border-2 border-slate-200 rounded-xl p-2.5 outline-none focus:border-emerald-500 transition text-sm"
                            placeholder="ID Number">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">{{ t.lblPassword }}</label>
                        <input v-model="loginCreds.password" type="password"
                            class="w-full border-2 border-slate-200 rounded-xl p-2.5 outline-none focus:border-emerald-500 transition text-sm"
                            placeholder="••••••••">
                    </div>

                    <button type="submit" :disabled="loginProcessing"
                        class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg flex items-center justify-center gap-2">
                        <span v-if="loginProcessing"><i class="fa-solid fa-circle-notch fa-spin"></i></span>
                        <span v-else>{{ t.btnLogin }}</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- MAIN APP -->
        <div v-else class="flex h-full w-full relative overflow-hidden">
            <!-- SIDEBAR -->
            <aside
                :class="['fixed md:static inset-y-0 z-[9001] w-64 bg-slate-950 text-slate-300 flex flex-col shadow-2xl transition-transform duration-300 ease-in-out border-e border-slate-800', isMobileMenuOpen ? 'translate-x-0' : (lang === 'ar' ? 'translate-x-full' : '-translate-x-full'), 'md:translate-x-0']">
                <div class="p-6 border-b border-slate-800 flex items-center gap-3 shrink-0">
                    <div class="w-10 h-10 flex items-center justify-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Emblem_of_Syria_%282025%E2%80%93present%29.svg/2560px-Emblem_of_Syria_%282025%E2%80%93present%29.svg.png"
                            class="max-w-full max-h-full object-contain drop-shadow">
                    </div>
                    <div>
                        <h1 class="font-bold text-white tracking-wide text-base leading-tight">E-TAPU</h1>
                        <p class="text-[9px] text-emerald-500 uppercase tracking-widest font-bold">DAMASCUS / ALEPPO</p>
                    </div>
                    <button @click="isMobileMenuOpen = false" class="md:hidden ms-auto text-slate-400"><i
                            class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
                    <p class="px-3 text-[10px] font-bold text-slate-500 uppercase mb-2 mt-2">{{ t.menuGeneral }}</p>
                    <button v-for="tab in ['dashboard', 'properties', 'transfer', 'ocr']" @click="changeTab(tab)"
                        :class="currentTab === tab ? 'bg-emerald-700 text-white shadow-lg' : 'hover:bg-slate-800 hover:text-white'"
                        class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-medium"><i
                            :class="getIcon(tab)" class="w-5 text-center text-lg"></i> {{ t['nav' + capitalize(tab)]
                        }}</button>
                    <p class="px-3 text-[10px] font-bold text-slate-500 uppercase mb-2 mt-6">{{ t.menuServices }}</p>
                    <button v-for="tab in ['valuation', 'expropriation']" @click="changeTab(tab)"
                        :class="currentTab === tab ? 'bg-emerald-700 text-white shadow-lg' : 'hover:bg-slate-800 hover:text-white'"
                        class="w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all text-sm font-medium"><i
                            :class="getIcon(tab)" class="w-5 text-center text-lg"></i> {{ t['nav' + capitalize(tab)]
                        }}</button>
                </nav>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="flex-1 flex flex-col bg-slate-50 h-full overflow-hidden w-full">
                <!-- Header (Only show non-OCR controls on other tabs) -->
                <header
                    class="h-16 bg-white shadow-sm border-b px-4 md:px-6 flex justify-between items-center z-10 shrink-0">
                    <div class="flex items-center gap-3">
                        <button @click="isMobileMenuOpen = !isMobileMenuOpen"
                            class="md:hidden text-slate-600 text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                        <h2 class="text-sm md:text-lg font-bold text-slate-800 flex items-center gap-2 truncate"><span
                                class="w-1.5 h-5 bg-red-600 rounded-full hidden md:block"></span> {{ t[currentTab +
                            'Title'] || t.navMap }}</h2>
                    </div>
                    <div class="flex items-center gap-3" v-if="currentTab === 'dashboard'">
                        <div class="relative group">
                            <input type="file" ref="fileInput" @change="handleFileUpload"
                                accept=".kmz,.kml,.json,.geojson" class="hidden">
                            <button @click="$refs.fileInput.click()"
                                class="bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-slate-900 transition flex items-center gap-2 text-xs md:text-sm font-bold border border-slate-600"><i
                                    class="fa-solid fa-cloud-arrow-up"></i> <span>{{
                                    t.btnUploadKMZ }}</span></button>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-2 md:p-6 relative">
                    <!-- DASHBOARD (Map) -->
                    <div v-show="currentTab === 'dashboard'" class="h-full flex flex-col gap-4">
                        <div
                            class="flex-1 bg-white rounded-xl shadow-lg border border-slate-200 flex flex-col overflow-hidden relative min-h-[400px]">
                            <div class="absolute top-3 start-3 z-[400] w-full max-w-[200px] md:max-w-xs flex gap-2">
                                <div
                                    class="flex gap-2 bg-white/95 backdrop-blur p-1.5 rounded-lg shadow-xl border border-slate-200 flex-1">
                                    <input v-model="searchQuery" @keyup.enter="locateProperty"
                                        :placeholder="t.searchPlaceholder"
                                        class="flex-1 bg-transparent border-none outline-none px-2 text-xs md:text-sm w-full"><button
                                        @click="locateProperty"
                                        class="bg-emerald-600 text-white px-3 py-1 rounded text-xs md:text-sm font-bold"><i
                                            class="fa-solid fa-search"></i></button>
                                </div>
                            </div>
                            <div id="map"></div>

                            <!-- Map Settings Floating Menu -->
                            <div class="absolute bottom-6 start-6 z-[1000] flex flex-col items-start gap-2">
                                <button @click="showMapSettings = !showMapSettings"
                                    class="bg-white/95 backdrop-blur p-3 rounded-xl shadow-xl border border-slate-200 text-slate-700 hover:text-emerald-600 transition flex items-center gap-2 font-bold text-xs ring-1 ring-slate-200">
                                    <i class="fa-solid fa-palette text-lg"></i>
                                    <span>Görünüm Ayarları</span>
                                </button>

                                <transition name="modal">
                                    <div v-if="showMapSettings"
                                        class="bg-white/95 backdrop-blur p-5 rounded-2xl shadow-2xl border border-slate-200 w-64 animate-fade-in ring-1 ring-slate-200">
                                        <div
                                            class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                                            <h4 class="font-bold text-xs text-slate-800 uppercase tracking-wider">Harita
                                                Stili</h4>
                                            <button @click="showMapSettings = false"
                                                class="text-slate-400 hover:text-red-500"><i
                                                    class="fa-solid fa-xmark"></i></button>
                                        </div>

                                        <div class="space-y-4">
                                            <div>
                                                <label
                                                    class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Çizgi
                                                    Rengi</label>
                                                <div class="flex flex-wrap gap-2">
                                                    <button
                                                        v-for="c in ['#e11d48', '#2563eb', '#16a34a', '#d97706', '#7c3aed', '#000000']"
                                                        @click="mapStyle.color = c" :style="{ backgroundColor: c }"
                                                        :class="['w-6 h-6 rounded-full border-2 transition', mapStyle.color === c ? 'border-emerald-500 scale-125' : 'border-transparent']">
                                                    </button>
                                                </div>
                                            </div>

                                            <div>
                                                <div class="flex justify-between mb-1">
                                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Çizgi
                                                        Kalınlığı</label>
                                                    <span class="text-[10px] font-mono text-slate-400">{{
                                                        mapStyle.weight }}px</span>
                                                </div>
                                                <input type="range" v-model.number="mapStyle.weight" min="1" max="10"
                                                    step="1"
                                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                            </div>

                                            <div>
                                                <div class="flex justify-between mb-1">
                                                    <label
                                                        class="text-[10px] font-bold text-slate-500 uppercase">Şeffaflık
                                                        (Dolgu)</label>
                                                    <span class="text-[10px] font-mono text-slate-400">{{
                                                        Math.round(mapStyle.fillOpacity * 100) }}%</span>
                                                </div>
                                                <input type="range" v-model.number="mapStyle.fillOpacity" min="0"
                                                    max="1" step="0.1"
                                                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                            </div>
                                        </div>
                                    </div>
                                </transition>
                            </div>

                            <!-- KMZ Loading Overlay -->
                            <div v-if="kmzLoading"
                                class="absolute inset-0 z-[2000] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in">
                                <div class="kmz-loader p-6 rounded-2xl flex flex-col items-center gap-4 shadow-2xl">
                                    <div
                                        class="w-12 h-12 rounded-full border-4 border-emerald-500/20 border-t-emerald-500 animate-spin">
                                    </div>
                                    <div class="text-center">
                                        <p class="text-white font-bold text-sm tracking-widest uppercase mb-1">Katman
                                            Yükleniyor</p>
                                        <p class="text-emerald-400 text-xs font-medium">{{ loadingMsg || 'KMZ İşleniyor...' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OCR Module (REDESIGNED) -->
                    <div v-if="currentTab === 'ocr'" class="animate-fade-in max-w-7xl mx-auto h-full flex flex-col">
                        <div
                            class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 flex-1 flex flex-col md:flex-row h-full">

                            <!-- Left: Image Viewer -->
                            <div
                                class="w-full md:w-1/2 bg-slate-800 p-4 flex flex-col relative border-e border-slate-700">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-white font-bold flex items-center gap-2"><i
                                            class="fa-solid fa-file-contract text-emerald-400"></i> {{ t.ocrOriginalDoc
                                        }}</h3>
                                    <div class="flex gap-2">
                                        <input type="file" ref="ocrInput" @change="handleOcrUpload"
                                            accept="image/*,.pdf" class="hidden">
                                        <button @click="openOcrPicker($event)"
                                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-lg border border-blue-500 flex items-center gap-2">
                                            <i class="fa-solid fa-cloud-arrow-up"></i> {{ t.ocrUpload }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Viewer Toolbar -->
                                <div
                                    class="flex items-center gap-2 mb-2 bg-slate-900/50 p-2 rounded-lg border border-slate-700 overflow-x-auto">
                                    <button @click="viewerScale *= 1.2"
                                        class="p-2 text-white hover:bg-slate-700 rounded transition" title="Yakinlas"><i
                                            class="fa-solid fa-plus"></i></button>
                                    <button @click="viewerScale *= 0.8"
                                        class="p-2 text-white hover:bg-slate-700 rounded transition" title="Uzaklas"><i
                                            class="fa-solid fa-minus"></i></button>
                                    <button @click="resetViewer"
                                        class="p-2 text-white hover:bg-slate-700 rounded transition" title="Sifirla"><i
                                            class="fa-solid fa-compress"></i></button>
                                    <div class="w-px h-4 bg-slate-700 mx-1"></div>
                                    <button @click="viewerMode = 'pan'"
                                        :class="['p-2 rounded transition', viewerMode === 'pan' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:bg-slate-700']"
                                        title="Kaydirma Modu">
                                        <i class="fa-solid fa-hand"></i>
                                    </button>
                                    <button @click="viewerMode = 'select'"
                                        :class="['p-2 rounded transition', viewerMode === 'select' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:bg-slate-700']"
                                        title="Secerek Zoom Modu">
                                        <i class="fa-solid fa-vector-square"></i>
                                    </button>
                                    <div
                                        class="ms-auto flex items-center gap-2 text-[10px] text-slate-500 font-mono px-2">
                                        {{ Math.round(viewerScale * 100) }}%
                                    </div>
                                </div>

                                <div ref="viewerContainer" @wheel="handleViewerWheel" @mousedown="handleViewerMouseDown"
                                    @mousemove="handleViewerMouseMove" @mouseup="handleViewerMouseUp"
                                    @mouseleave="handleViewerMouseUp"
                                    class="flex-1 bg-slate-900/50 rounded-xl border-2 border-dashed border-slate-600 flex items-center justify-center relative overflow-hidden group select-none cursor-crosshair"
                                    :style="{ cursor: viewerMode === 'pan' ? (isPanning ? 'grabbing' : 'grab') : 'crosshair' }">

                                    <div v-if="!ocrImage" class="text-slate-500 flex flex-col items-center">
                                        <i class="fa-solid fa-file-invoice text-5xl mb-4 opacity-50"></i>
                                        <p class="text-sm font-medium">{{ t.ocrPlaceholder }}</p>
                                    </div>

                                    <div v-else class="relative transition-transform duration-75 ease-out"
                                        :style="{ transform: `translate(${viewerPanX}px, ${viewerPanY}px) scale(${viewerScale})` }">
                                        <img :src="ocrImage"
                                            class="max-w-full max-h-[80vh] shadow-2xl pointer-events-none">
                                    </div>

                                    <!-- Selection Box -->
                                    <div v-if="isSelecting"
                                        class="absolute border-2 border-emerald-400 bg-emerald-400/20 z-20 pointer-events-none"
                                        :style="{ 
                                                top: selectionRect.top + 'px', 
                                                left: selectionRect.left + 'px', 
                                                width: selectionRect.width + 'px', 
                                                height: selectionRect.height + 'px' 
                                            }">
                                    </div>

                                    <!-- Scanning Effect -->
                                    <div v-if="ocrScanning"
                                        class="absolute top-0 left-0 w-full h-2 bg-emerald-400/80 shadow-[0_0_20px_rgba(52,211,153,0.8)] animate-scan z-10">
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Smart Editor Form -->
                            <div class="w-full md:w-1/2 p-0 flex flex-col bg-slate-50 overflow-hidden">
                                <div class="p-6 border-b bg-white">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                                <i class="fa-solid fa-wand-magic-sparkles text-purple-600"></i> {{
                                                t.ocrAnalysisTitle }}
                                            </h3>
                                            <p class="text-xs text-slate-500 mt-1">{{ t.ocrAnalysisSubtitle }}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                                    <!-- Loading State -->
                                    <div v-if="ocrScanning"
                                        class="flex flex-col items-center justify-center h-full text-slate-400 gap-4">
                                        <div class="relative">
                                            <div
                                                class="w-16 h-16 border-4 border-slate-200 border-t-emerald-500 rounded-full animate-spin">
                                            </div>
                                            <i
                                                class="fa-solid fa-brain absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-emerald-500 text-xl"></i>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-sm font-bold text-slate-600">AI Belgeyi Analiz Ediyor...</p>
                                            <p class="text-xs text-slate-400 mt-1">OCR Motoru: Google Cloud Vision v2
                                            </p>
                                            <p class="text-xs text-slate-400">Veri İşleme: n8n Workflow</p>
                                        </div>
                                    </div>

                                    <!-- Extracted Data Form -->
                                    <div v-else-if="ocrForm" class="space-y-6 animate-fade-in">

                                        <!-- Mülkiyet Bilgileri -->
                                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative">
                                            <div
                                                class="absolute -top-3 right-4 bg-emerald-100 text-emerald-800 text-[10px] font-bold px-2 py-0.5 rounded border border-emerald-200">
                                                Mülkiyet</div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Malik
                                                        Adı Soyadı</label>
                                                    <input v-model="ocrForm.owner_name"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-800 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Hisse</label>
                                                    <input v-model="ocrForm.share_text"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">İşlem
                                                        Tarihi</label>
                                                    <input v-model="ocrForm.signature_date"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                </div>
                                                <div class="col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Yevmiye
                                                        No / İşlem Türü</label>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <input v-model="ocrForm.daily_register_no"
                                                            placeholder="Yevmiye No"
                                                            class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                        <input v-model="ocrForm.transaction_type"
                                                            placeholder="İşlem Türü"
                                                            class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Taşınmaz Kimliği -->
                                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative">
                                            <div
                                                class="absolute -top-3 right-4 bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-200">
                                                Taşınmaz Kimliği</div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">İl
                                                        / Bölge</label>
                                                    <input v-model="ocrForm.province"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">İlçe
                                                        / Semt</label>
                                                    <input v-model="ocrForm.district"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                </div>
                                                <div class="col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Müdürlük
                                                        / Daire</label>
                                                    <input v-model="ocrForm.directorate"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                </div>
                                                <div class="col-span-2 relative">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ada
                                                        / Parsel No</label>
                                                    <div class="flex gap-2">
                                                        <input v-model="ocrForm.property_number"
                                                            class="flex-1 p-2.5 bg-yellow-50 border border-yellow-300 rounded-lg text-sm font-black text-slate-900 tracking-wider">
                                                        <button @click="openOcrMapModal"
                                                            class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition shadow flex items-center justify-center gap-2 text-xs font-bold"
                                                            title="Haritada Eşleştir">
                                                            <i class="fa-solid fa-map-location-dot"></i> Eşleştir
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nitelik
                                                        / Cins / Yüzölçümü</label>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <input v-model="ocrForm.property_type" placeholder="Nitelik"
                                                            class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                        <input v-model="ocrForm.area_text" placeholder="Yüzölçümü"
                                                            class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700">
                                                    </div>
                                                </div>
                                                <div class="col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Açıklama</label>
                                                    <textarea v-model="ocrForm.description" rows="2"
                                                        class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-700 resize-none"></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="pt-2">
                                            <button @click="saveAndGenerateDeed"
                                                class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition flex items-center justify-center gap-3 shadow-lg transform active:scale-95">
                                                <i class="fa-solid fa-file-signature"></i> Onayla ve Tapu Oluştur
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Empty State -->
                                    <div v-else
                                        class="flex flex-col items-center justify-center h-full text-slate-400 opacity-50">
                                        <i class="fa-solid fa-arrow-right-to-bracket text-4xl mb-4 text-slate-300"></i>
                                        <p>Analiz için soldan bir belge yükleyin.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Tabs... -->
                </div>
            </main>
        </div>

        <!-- MAP PICKER MODAL (Specific for OCR) -->
        <transition name="modal">
            <div v-if="modals.ocrMap"
                class="fixed inset-0 z-[10000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                <div
                    class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col relative">
                    <div class="p-4 bg-slate-900 text-white flex justify-between items-center shrink-0">
                        <h3 class="font-bold flex items-center gap-2"><i
                                class="fa-solid fa-map-pin text-emerald-400"></i> Parsel Seçimi</h3>
                        <button @click="modals.ocrMap = false" class="hover:text-red-400 transition"><i
                                class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    <div class="flex-1 relative bg-slate-100">
                        <!-- We use a separate map container ID to avoid conflicts -->
                        <div id="ocr-map-picker" class="w-full h-full z-10"></div>

                        <div
                            class="absolute bottom-6 left-1/2 -translate-x-1/2 z-[500] bg-white px-6 py-3 rounded-full shadow-xl border border-slate-200 flex gap-4 items-center">
                            <p class="text-sm font-bold text-slate-700" v-if="tempSelectedParcel">Seçili: <span
                                    class="text-emerald-600">#{{ tempSelectedParcel }}</span></p>
                            <p class="text-sm text-slate-400" v-else>Lütfen haritadan bir parsel seçin</p>
                            <button @click="confirmOcrMapSelection" :disabled="!tempSelectedParcel"
                                class="bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold disabled:opacity-50 hover:bg-slate-800 transition">Seçimi
                                Onayla</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Tapu Deed Modal (Reused) -->
        <transition name="modal">
            <div v-if="modals.deed"
                class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
                @click.self="modals.deed = false">
                <!-- Modal content similar to previous deed modal but dynamic -->
                <div
                    class="relative w-full max-w-4xl h-[90vh] flex flex-col items-center justify-center pointer-events-none">
                    <button @click="modals.deed = false"
                        class="absolute -top-4 -right-4 md:-right-8 w-12 h-12 bg-red-800 text-white rounded-full flex items-center justify-center z-[10000] shadow-2xl hover:bg-red-900 hover:scale-110 transition cursor-pointer pointer-events-auto border-4 border-white"><i
                            class="fa-solid fa-xmark text-2xl"></i></button>
                    <div class="bg-white w-full h-full shadow-2xl overflow-y-auto pointer-events-auto relative tapu-bg scale-100 origin-center"
                        style="background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');"
                        :dir="lang === 'ar' ? 'rtl' : 'ltr'">
                        <!-- Decorative Frame and Content -->
                        <div class="min-h-full p-2 border-[16px] border-double border-slate-900 m-2">
                            <div class="h-full border-[2px] border-gold-600 p-6 relative">
                                <!-- Watermark & Header -->
                                <div
                                    class="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none overflow-hidden">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Emblem_of_Syria_%282025%E2%80%93present%29.svg/2560px-Emblem_of_Syria_%282025%E2%80%93present%29.svg.png"
                                        class="w-[800px] grayscale">
                                </div>
                                <div class="text-center mb-12 relative z-10 pt-8">
                                    <div class="flex justify-center items-center gap-6 mb-4"><img
                                            src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Emblem_of_Syria_%282025%E2%80%93present%29.svg/2560px-Emblem_of_Syria_%282025%E2%80%93present%29.svg.png"
                                            class="h-24 drop-shadow-xl"></div>
                                    <h1 class="text-3xl md:text-4xl font-black text-slate-900 uppercase tracking-[0.2em] font-serif mb-2"
                                        style="font-family: 'Amiri', serif;">{{ t.syrianRepublic }}</h1>
                                    <h2
                                        class="text-xl md:text-2xl font-bold text-slate-700 font-serif border-b-2 border-slate-900 inline-block pb-2 px-12">
                                        {{ t.cadastreDirectorate }}</h2>
                                    <div class="mt-8">
                                        <h3 class="text-5xl md:text-6xl font-black text-red-900 border-4 border-double border-red-900 inline-block px-12 py-3 transform -rotate-1 shadow-sm"
                                            style="font-family: 'Amiri', serif;">{{ t.modalDeedTitle }}</h3>
                                    </div>
                                </div>
                                <!-- Content -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10 px-4 md:px-12">
                                    <div class="space-y-4">
                                        <h4
                                            class="font-bold text-xl text-slate-900 border-b-4 border-gold-600 pb-2 mb-4 font-serif">
                                            <i class="fa-solid fa-hotel me-2"></i> {{ t.propertyInfo }}
                                        </h4>
                                        <table class="w-full text-sm font-serif border-collapse">
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500 w-1/3">{{ t.colCity }}</td>
                                                <td class="py-2 font-bold text-lg text-slate-900">{{
                                                    modals.activeProp.location }}</td>
                                            </tr>
                                            <tr v-if="modals.activeProp.directorate" class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">Müdürlük</td>
                                                <td class="py-2 font-bold text-slate-900">{{
                                                    modals.activeProp.directorate }}</td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">{{ t.colParcel }}</td>
                                                <td class="py-2 font-bold text-lg text-slate-900">
                                                    {{ modals.activeProp.ada }}/{{ modals.activeProp.parsel }}
                                                </td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">{{ t.colType }}</td>
                                                <td class="py-2 font-bold text-lg text-slate-900">{{
                                                    modals.activeProp.type }}</td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">{{ t.area }}</td>
                                                <td class="py-2 font-bold text-lg text-slate-900">{{
                                                    modals.activeProp.area_text }} m²</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="space-y-4">
                                        <h4
                                            class="font-bold text-xl text-slate-900 border-b-4 border-gold-600 pb-2 mb-4 font-serif">
                                            <i class="fa-solid fa-user-shield me-2"></i> {{ t.ownerInfo }}
                                        </h4>
                                        <table class="w-full text-sm font-serif border-collapse">
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500 w-1/3">{{ t.ownerName }}</td>
                                                <td class="py-2 font-bold text-xl text-slate-900">{{
                                                    modals.activeProp.owner_name }}</td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">Hisse</td>
                                                <td class="py-2 font-bold text-slate-900">{{
                                                    modals.activeProp.share_text || 'Tamamı (1/1)' }}</td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">İşlem Detayı</td>
                                                <td class="py-2 text-slate-900">
                                                    <span class="font-bold">{{ modals.activeProp.transaction_type ||
                                                        'Kayıt' }}</span>
                                                    <br>
                                                    <span class="text-xs text-slate-500">Yevmiye: {{
                                                        modals.activeProp.daily_register_no || '---' }}</span>
                                                </td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">Tarih</td>
                                                <td class="py-2 font-bold text-slate-900">{{
                                                    modals.activeProp.signature_date }}</td>
                                            </tr>
                                            <tr class="border-b border-slate-300">
                                                <td class="py-2 text-slate-500">{{ t.electronicValidation }}</td>
                                                <td class="py-2 font-mono text-slate-900 tracking-widest">
                                                    SY-{{ modals.activeProp.daily_register_no ||
                                                    Math.floor(Math.random()*900000)+100000 }}
                                                </td>
                                            </tr>
                                        </table>
                                        <div class="mt-6 flex justify-end">
                                            <div class="text-center">
                                                <img :src="`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SYRIAN-DEED-${modals.activeProp.ada}-${modals.activeProp.parsel}`"
                                                    class="w-24 h-24 border-2 border-slate-900 p-1 mb-1">
                                                <p class="text-[8px] font-mono text-slate-500">E-DEVLET DOĞRULAMA</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Footer -->
                                <div
                                    class="mt-16 flex flex-col md:flex-row justify-between items-end px-12 pb-12 relative z-10">
                                    <div class="text-center"></div>
                                    <div class="text-center relative mt-8 md:mt-0">
                                        <div
                                            class="absolute -top-12 left-1/2 transform -translate-x-1/2 w-40 h-40 border-4 border-red-800 rounded-full opacity-80 flex items-center justify-center animate-pulse">
                                            <div
                                                class="w-36 h-36 border-2 border-red-800 rounded-full flex items-center justify-center">
                                                <div
                                                    class="text-center text-red-800 font-bold text-[10px] uppercase tracking-widest rotate-[-15deg]">
                                                    Syrian Arab Republic<br>Cadastre<br>OFFICIAL</div>
                                            </div>
                                        </div>
                                        <p class="font-bold text-2xl text-blue-900 font-script relative z-10 font-serif italic"
                                            style="font-family: 'Amiri', serif;">Ahmad Al-Faruqi</p>
                                        <div class="w-64 h-0.5 bg-slate-900 my-2"></div>
                                        <p class="text-sm font-bold uppercase tracking-widest">{{ t.officialTitle }}</p>
                                    </div>
                                </div>
                                <div class="absolute bottom-4 left-4 no-print flex gap-2">
                                    <button onclick="window.print()"
                                        class="bg-slate-800 text-white px-4 py-2 rounded shadow hover:bg-slate-700 text-xs font-bold"><i
                                            class="fa-solid fa-print"></i> Yazdır</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <div v-if="toast.show"
            class="fixed bottom-6 end-6 bg-slate-900 text-white p-4 rounded-xl shadow-2xl z-[10000] max-w-xs border-s-4 border-emerald-500"
            :dir="lang === 'ar' ? 'rtl' : 'ltr'">
            <h4 class="font-bold text-sm">{{ toast.title }}</h4>
            <p class="text-xs text-slate-400">{{ toast.message }}</p>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch, markRaw, toRaw } = Vue;

        const translations = {
            tr: {
                loading: 'YÜKLENİYOR...', loadingMsg: 'Suriye CBS Çekirdeğine Bağlanılıyor...', menuGeneral: 'GENEL İŞLEMLER', menuServices: 'HİZMETLER', menuAdmin: 'YÖNETİCİ & DENETİM', navMap: 'Harita & CBS', navProperties: 'Mülk Listesi', navTransfer: 'Tapu Devir/Satış', navValuation: 'Değer Hesapla', navExpropriation: 'Kamulaştırma', navLogs: 'Denetim Logları', navOcr: 'Akıllı Tapu (AI)', searchPlaceholder: 'Ada/Parsel, Koordinat, Konum...', totalProperties: 'TOPLAM MÜLK', pendingApps: 'BEKLEYEN', riskCount: 'RİSKLİ', dashboardTitle: 'CBS Paneli', propertyListTitle: 'Taşınmaz Kayıtları', transferTitle: 'RESMİ TAPU DEVİR İŞLEMİ', colParcel: 'Ada/Parsel', colLocation: 'Konum', colType: 'Nitelik', colValue: 'Rayiç Bedel', colAction: 'İşlem', owner: 'Malik', btnViewDeed: 'Tapu', exportPdf: 'PDF İndir', typeSale: 'Satış', typeInheritance: 'Miras', labelSelectProp: 'Mülk Seçiniz', labelBuyerID: 'Alıcı Kimlik No', btnStartApp: 'Başvuru Yap', modalDeedTitle: 'TAPU SENEDİ', colCity: 'İl/İlçe', modalAppTitle: 'Randevu Oluştur', labelDate: 'Tarih Seçiniz', btnConfirm: 'Onayla', btnCheck: 'SORGULA', btnRecalculate: 'Yeniden Hesapla', estValue: 'Tahmini Değer', area: 'Yüzölçümü', age: 'Bina Yaşı', expSubtitle: 'Resmi Kısıtlama ve Kamulaştırma Sorgusu', decisionDate: 'Karar Tarihi', authority: 'İlgili Kurum', logout: 'Çıkış Yap', activeRegion: 'AKTİF BÖLGE',
                roleCitizen: 'Vatandaş', roleOfficer: 'Memur', roleRealtor: 'Emlakçı', loggedInAs: 'Giriş Yapan', secureLogin: 'Güvenli Giriş',
                ocrOriginalDoc: 'Orijinal Tapu Belgesi', ocrUpload: 'Belge Yükle', ocrPlaceholder: 'Tapu görselini veya PDF\'i buraya yükleyin', ocrAnalysisTitle: 'Yapay Zeka Analizi', ocrAnalysisSubtitle: 'Belge taranıyor ve veriler çıkarılıyor...', ocrAiNote: 'Bu veriler yapay zeka ile çıkarılmıştır, lütfen kontrol ediniz.', ocrVerifyMap: 'Haritada Doğrula', ocrConfirm: 'Verileri Onayla',
                ownerName: 'Malik Adı', acquisitionReason: 'Edinim Sebebi', electronicValidation: 'Elektronik Doğrulama', propertyInfo: 'Taşınmaz Bilgileri', ownerInfo: 'Mülkiyet Bilgileri', officialTitle: 'Yetkili İmza'
            },
            ar: {
                loading: 'جار التحميل...', loadingMsg: 'جاري الاتصال...', menuGeneral: 'العمليات', menuServices: 'الخدمات', menuAdmin: 'الإدارة', navMap: 'الخريطة', navProperties: 'القائمة', navTransfer: 'نقل الملكية', navValuation: 'التقييم', navExpropriation: 'الاستعلام', navLogs: 'السجلات', navOcr: 'طابو ذكي (AI)',
                roleCitizen: 'مواطن', roleOfficer: 'موظف', roleRealtor: 'وسيط',
                ocrOriginalDoc: 'الوثيقة الأصلية', ocrUpload: 'رفع وتحليل', ocrPlaceholder: 'تحميل صورة الطابو', ocrAnalysisTitle: 'تحليل الذكاء الاصطناعي', ocrAnalysisSubtitle: 'جاري المعالجة...', ocrVerifyMap: 'مطابقة على الخريطة', ocrConfirm: 'تأكيد وحفظ',
                ownerName: 'اسم المالك', acquisitionReason: 'سبب الاكتساب', electronicValidation: 'التحقق الإلكتروني', propertyInfo: 'معلومات العقار', ownerInfo: 'معلومات الملكية', officialTitle: 'التوقيع المعتمد'
            },
            en: {
                loading: 'LOADING...', loadingMsg: 'Connecting to Damascus GIS Core...', menuGeneral: 'OPERATIONS', menuServices: 'SERVICES', menuAdmin: 'ADMIN & AUDIT', navMap: 'Map & GIS', navProperties: 'Properties', navTransfer: 'Transfer', navValuation: 'Valuation', navExpropriation: 'Inquiry', navLogs: 'Audit Logs', navOcr: 'Smart Deed (AI)', searchPlaceholder: 'Search Parcel, Coords, Location...', totalProperties: 'PROPERTIES', pendingApps: 'PENDING', riskCount: 'AT RISK', dashboardTitle: 'GIS Dashboard', propertyListTitle: 'Property Records', transferTitle: 'OFFICIAL TITLE TRANSFER', colParcel: 'Parcel', colLocation: 'Location', colType: 'Type', colValue: 'Value', colAction: 'Action', owner: 'Owner', btnViewDeed: 'Deed', exportPdf: 'Export PDF', typeSale: 'Sale', typeInheritance: 'Inheritance', labelSelectProp: 'Select Property', labelBuyerID: 'Buyer ID', btnStartApp: 'Apply', modalDeedTitle: 'TITLE DEED', colCity: 'City/District', modalAppTitle: 'Appointment', labelDate: 'Select Date', btnConfirm: 'Confirm', btnCheck: 'CHECK', btnRecalculate: 'Recalculate', estValue: 'Est. Value', area: 'Area', age: 'Building Age', expSubtitle: 'Official Restriction Inquiry', decisionDate: 'Decision Date', authority: 'Authority', logout: 'Logout', activeRegion: 'ACTIVE REGION',
                roleCitizen: 'Citizen', roleOfficer: 'Officer', roleRealtor: 'Realtor', loggedInAs: 'Logged In As', secureLogin: 'Secure Login',
                ocrOriginalDoc: 'Original Title Deed', ocrUpload: 'Upload Document', ocrPlaceholder: 'Upload deed image or PDF here', ocrAnalysisTitle: 'AI Analysis', ocrAnalysisSubtitle: 'Scanning document and extracting data...', ocrAiNote: 'Data extracted by AI, please verify.', ocrVerifyMap: 'Verify on Map', ocrConfirm: 'Confirm Data',
                ownerName: 'Owner Name', acquisitionReason: 'Acquisition Reason', electronicValidation: 'Electronic Validation', propertyInfo: 'Property Info', ownerInfo: 'Ownership Info', officialTitle: 'Authorized Signature'
            }
        };

        createApp({
            setup() {
                // 1. STATE
                const loading = ref(false);
                const loadingMsg = ref('');
                const lang = ref('ar');
                const isLoggedIn = ref(false);
                const loginCreds = ref({ username: '', password: '' });
                const loginProcessing = ref(false);
                const isMobileMenuOpen = ref(false);
                const loginRole = ref('citizen');
                const currentTab = ref('dashboard');
                const map = ref(null);
                const ocrMap = ref(null);
                const searchQuery = ref('');
                const selectedPropertyId = ref(1);
                const properties = ref([]);
                const auditLogs = ref([]);
                const geoJsonLayer = ref(null);
                const ocrGeoJsonLayer = ref(null);
                const valRegion = ref('mezzeh');
                const valArea = ref(150);
                const valAge = ref(5);
                const activeRegionName = ref('Damascus / Mezzeh');
                const expLoading = ref(false);
                const expResult = ref(null);
                const modals = ref({ deed: false, appointment: false, activeProp: null, ocrMap: false });
                const toast = ref({ show: false, title: '', message: '' });
                const showMapSettings = ref(false);
                const ocrImage = ref(null);
                const ocrScanning = ref(false);
                const ocrData = ref(null);
                const ocrForm = ref({
                    owner_name: '',
                    signature_date: '',
                    share_text: '',
                    province: '',
                    district: '',
                    directorate: '',
                    property_number: '',
                    property_type: '',
                    area_text: '',
                    daily_register_no: '',
                    transaction_type: '',
                    description: ''
                }); // OCR form data
                const tempSelectedParcel = ref(null); // For map picker
                const kmzLoading = ref(false); // New state for KMZ specific loading
                const mapStyle = ref({
                    color: '#e11d48', // Default Rose 600
                    weight: 2,
                    fillOpacity: 0.2
                });

                // Viewer State
                const viewerScale = ref(1);
                const viewerPanX = ref(0);
                const viewerPanY = ref(0);
                const viewerMode = ref('pan'); // 'pan' | 'select'
                const isPanning = ref(false);
                const isSelecting = ref(false);
                const selectionStart = ref({ x: 0, y: 0 });
                const selectionRect = ref({ top: 0, left: 0, width: 0, height: 0 });
                const viewerContainer = ref(null);

                // 2. HELPER FUNCTIONS
                const showSuccess = (title, msg) => { toast.value = { show: true, title, message: msg }; setTimeout(() => toast.value.show = false, 3000); };
                const setLang = (c) => { lang.value = c; document.documentElement.setAttribute('dir', c === 'ar' ? 'rtl' : 'ltr'); };
                const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
                const getIcon = (tab) => { const icons = { dashboard: 'fa-map-location-dot', properties: 'fa-list-check', transfer: 'fa-handshake-simple', valuation: 'fa-calculator', expropriation: 'fa-gavel', logs: 'fa-shield-cat', ocr: 'fa-wand-magic-sparkles' }; return 'fa-solid ' + icons[tab]; };
                const changeTab = (tab) => {
                    currentTab.value = tab;
                    isMobileMenuOpen.value = false;
                    if (tab === 'dashboard') nextTick(() => map.value?.invalidateSize());
                };

                // Watch for map style changes to re-render
                watch(mapStyle, () => {
                    if (currentTab.value === 'dashboard' && map.value) {
                        renderGeoJSON();
                    }
                }, { deep: true });

                // 3. COMPUTED
                const t = computed(() => translations[lang.value]);
                const selectedProperty = computed(() => properties.value.find(p => p.id === selectedPropertyId.value));
                const totalValue = computed(() => {
                    const sum = properties.value.reduce((acc, p) => acc + (p.price || 0), 0);
                    return '$' + (sum / 1000000).toFixed(1) + 'M';
                });
                const filteredProperties = computed(() => {
                    let props = properties.value;
                    if (!searchQuery.value) return props;
                    const q = searchQuery.value.toLowerCase().trim();
                    return props.filter(p => {
                        const adaParsel = `${p.ada}/${p.parsel}`;
                        return (p.ada.toString().includes(q) || p.parsel.toString().includes(q) || adaParsel.includes(q) || (p.owner && p.owner.toLowerCase().includes(q)) || (p.location && p.location.toLowerCase().includes(q)));
                    });
                });
                const valuationResult = computed(() => { return `$${(valArea.value * 2000).toLocaleString()}`; });

                // 4. LOGIC
                const initMap = () => {
                    if (map.value) return;
                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
                    map.value = markRaw(L.map('map', { center: [33.5138, 36.29], zoom: 14, layers: [satelliteLayer], renderer: L.canvas(), zoomControl: false }));
                    L.control.zoom({ position: 'bottomright' }).addTo(map.value);

                    // If properties were pre-loaded (e.g. via KMZ auto-load), render them now
                    if (properties.value.length > 0) {
                        nextTick(() => renderGeoJSON());
                    }
                };

                const initOcrMap = () => {
                    // Separate map instance for OCR Picker to avoid conflicts
                    if (ocrMap.value) {
                        ocrMap.value.remove(); // Reset if exists
                    }

                    setTimeout(() => {
                        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
                        ocrMap.value = markRaw(L.map('ocr-map-picker', { center: [33.5138, 36.29], zoom: 14, layers: [satelliteLayer], renderer: L.canvas(), zoomControl: false }));
                        L.control.zoom({ position: 'bottomright' }).addTo(ocrMap.value);

                        // Add parcels to this map too
                        const rawProperties = toRaw(properties.value);
                        const featureCollection = { type: "FeatureCollection", features: rawProperties.map(p => ({ type: "Feature", properties: { id: p.id, ...p }, geometry: toRaw(p.geometry) })) };

                        const layer = L.geoJSON(featureCollection, {
                            style: { color: '#3b82f6', weight: 2, fillOpacity: 0.1 },
                            onEachFeature: (feature, layer) => {
                                layer.on('click', () => {
                                    // Highlight logic
                                    // Reset style first (simplified)
                                    // Set clicked style
                                    layer.setStyle({ color: '#ef4444', weight: 4, fillOpacity: 0.6 });
                                    const p = feature.properties;
                                    tempSelectedParcel.value = `${p.ada}/${p.parsel}`;
                                    // Update form data (mock)
                                    if (ocrData.value) {
                                        ocrData.value.kimlik.parsel_no = `${p.ada}/${p.parsel}`;
                                        ocrData.value.baslik.bolge = p.location;
                                    }
                                });
                            }
                        }).addTo(ocrMap.value);

                        // Fit bounds
                        try { ocrMap.value.fitBounds(layer.getBounds()); } catch (e) { }
                    }, 100);
                };

                const renderGeoJSON = () => {
                    const rawMap = toRaw(map.value);
                    if (!rawMap) return;
                    if (geoJsonLayer.value) rawMap.removeLayer(toRaw(geoJsonLayer.value));

                    const rawProperties = toRaw(properties.value);
                    const featureCollection = {
                        type: "FeatureCollection",
                        features: rawProperties.map(p => ({
                            type: "Feature",
                            properties: { id: p.id, ...p },
                            geometry: toRaw(p.geometry)
                        }))
                    };

                    geoJsonLayer.value = markRaw(L.geoJSON(featureCollection, {
                        style: {
                            color: mapStyle.value.color,
                            weight: mapStyle.value.weight,
                            fillOpacity: mapStyle.value.fillOpacity,
                            fillColor: mapStyle.value.color
                        },
                        onEachFeature: (feature, layer) => {
                            layer.on('click', () => {
                                const p = properties.value.find(x => x.id === feature.properties.id);
                                if (p) {
                                    selectedPropertyId.value = p.id;
                                    modals.value.activeProp = p;
                                    modals.value.deed = true;
                                }
                            });
                        }
                    }).addTo(rawMap));

                    try {
                        const bounds = geoJsonLayer.value.getBounds();
                        if (bounds.isValid()) rawMap.fitBounds(bounds);
                    } catch (e) { }
                };

                const handleLogin = () => {
                    loginProcessing.value = true;
                    // Eğer önceden KMZ vb ile parsel yüklenmemişse örnek parselleri oluştur
                    setTimeout(() => {
                        isLoggedIn.value = true;
                        loginProcessing.value = false;
                        loading.value = true;

                        if (properties.value.length === 0) {
                            generateMockParcels();
                        }

                        setTimeout(() => {
                            loading.value = false;
                            nextTick(() => initMap());
                        }, 1000);
                    }, 1000);
                };

                const generateMockParcels = () => {
                    // Generate logic... (Simplified for brevity as it's same as before)
                    const centerLat = 33.5138, centerLng = 36.2900;
                    const newProps = [];
                    for (let i = 0; i < 50; i++) {
                        const lat = centerLat + (Math.random() - 0.5) * 0.02;
                        const lng = centerLng + (Math.random() - 0.5) * 0.03;
                        newProps.push({
                            id: 1000 + i, ada: 101, parsel: i + 1, location: activeRegionName.value, type: 'Land', owner: 'MOCK OWNER', area: 500 + i * 10,
                            geometry: { type: "Polygon", coordinates: [[[lng - 0.0005, lat - 0.0005], [lng + 0.0005, lat - 0.0005], [lng + 0.0005, lat + 0.0005], [lng - 0.0005, lat + 0.0005], [lng - 0.0005, lat - 0.0005]]] }
                        });
                    }
                    properties.value = newProps;
                };

                // n8n webhook notu:
                // - /webhook-test/* sadece n8n editöründe "Listen for test event" açıkken çalışır (aksi halde 404 döner)
                // - Canlı kullanım için genelde /webhook/* (workflow aktifken) kullanılır
                //
                // İpucu: URL'yi kod değiştirmeden test etmek için query param ile override edebilirsin:
                // - index.html?n8n=https%3A%2F%2Fn8n.ittyazilim.com%2Fwebhook%2F6a41b4a1-abcb-4610-85c8-8b2ac4cb680a
                const N8N_WEBHOOK_URL_TEST = 'https://n8n.ittyazilim.com/webhook-test/6a41b4a1-abcb-4610-85c8-8b2ac4cb680a';
                const N8N_WEBHOOK_URL_PROD = 'https://n8n.ittyazilim.com/webhook/6a41b4a1-abcb-4610-85c8-8b2ac4cb680a';
                const ocrWebhookMode = ref('prod'); // 'prod' | 'test'
                const ocrInput = ref(null); // <input type="file" ref="ocrInput">

                const resolveN8nWebhookUrl = () => {
                    // Check if we are running on localhost (use proxy)
                    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

                    try {
                        const qp = new URLSearchParams(location.search);
                        const override = qp.get('n8n');
                        if (override) return override;
                    } catch (_) { }

                    let url = ocrWebhookMode.value === 'test' ? N8N_WEBHOOK_URL_TEST : N8N_WEBHOOK_URL_PROD;

                    // If local, rewrite URL to use local proxy
                    if (isLocalhost) {
                        // Replace 'https://n8n.ittyazilim.com' with '/n8n-proxy'
                        url = url.replace('https://n8n.ittyazilim.com', '/n8n-proxy');
                    }

                    return url;
                };

                // Shift+Click => TEST, normal click => PROD
                const openOcrPicker = (e) => {
                    ocrWebhookMode.value = e?.shiftKey ? 'test' : 'prod';
                    console.log(`OCR: Mod seçildi: ${ocrWebhookMode.value.toUpperCase()}`);

                    if (!ocrInput.value) {
                        console.error('OCR: ocrInput ref bulunamadı');
                        return;
                    }

                    // Aynı dosyayı tekrar seçebilmek için input'u sıfırla
                    ocrInput.value.value = '';
                    ocrInput.value.click();
                };

                // --- VIEWER FUNCTIONS ---
                const resetViewer = () => {
                    viewerScale.value = 1;
                    viewerPanX.value = 0;
                    viewerPanY.value = 0;
                };

                const handleViewerWheel = (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    const nextScale = viewerScale.value * delta;
                    if (nextScale > 0.1 && nextScale < 20) {
                        viewerScale.value = nextScale;
                    }
                };

                const handleViewerMouseDown = (e) => {
                    if (viewerMode.value === 'pan') {
                        isPanning.value = true;
                    } else {
                        isSelecting.value = true;
                        const rect = viewerContainer.value.getBoundingClientRect();
                        selectionStart.value = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                        selectionRect.value = { top: selectionStart.value.y, left: selectionStart.value.x, width: 0, height: 0 };
                    }
                };

                const handleViewerMouseMove = (e) => {
                    if (isPanning.value) {
                        viewerPanX.value += e.movementX;
                        viewerPanY.value += e.movementY;
                    } else if (isSelecting.value) {
                        const rect = viewerContainer.value.getBoundingClientRect();
                        const currentX = e.clientX - rect.left;
                        const currentY = e.clientY - rect.top;

                        selectionRect.value = {
                            left: Math.min(selectionStart.value.x, currentX),
                            top: Math.min(selectionStart.value.y, currentY),
                            width: Math.abs(currentX - selectionStart.value.x),
                            height: Math.abs(currentY - selectionStart.value.y)
                        };
                    }
                };

                const handleViewerMouseUp = () => {
                    if (isSelecting.value && selectionRect.value.width > 10) {
                        // Zoom to selection
                        const containerRect = viewerContainer.value.getBoundingClientRect();
                        const scaleX = containerRect.width / selectionRect.value.width;
                        const scaleY = containerRect.height / selectionRect.value.height;
                        const newScale = Math.min(scaleX, scaleY) * 0.9;

                        const centerX = selectionRect.value.left + selectionRect.value.width / 2;
                        const centerY = selectionRect.value.top + selectionRect.value.height / 2;

                        viewerScale.value *= newScale;
                        viewerPanX.value = (containerRect.width / 2 - centerX) * viewerScale.value;
                        viewerPanY.value = (containerRect.height / 2 - centerY) * viewerScale.value;

                        viewerMode.value = 'pan';
                    }
                    isPanning.value = false;
                    isSelecting.value = false;
                };

                const handleOcrUpload = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    console.log('OCR: Dosya yüklendi:', file.name, file.type, file.size, 'bytes');

                    // Görseli önizleme için oku
                    const previewReader = new FileReader();
                    previewReader.onload = (e) => { ocrImage.value = e.target.result; };
                    previewReader.readAsDataURL(file);

                    ocrScanning.value = true;
                    ocrData.value = null;

                    try {
                        // Dosyayı Base64'e çevir (n8n workflow JSON bekliyor)
                        const base64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                // DataURL'den "data:image/jpeg;base64," kısmını ayıkla
                                const base64String = reader.result.split(',')[1];
                                resolve(base64String);
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });

                        const webhookUrl = resolveN8nWebhookUrl();
                        console.log('OCR: Webhook\'a gönderiliyor...', webhookUrl);

                        const response = await fetch(webhookUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ data: base64 }) // Payload: { "data": "BASE64_STRING" }
                        });

                        console.log('OCR: Webhook yanıtı:', response.status, response.statusText);

                        if (response.ok) {
                            const result = await response.json();
                            console.log('--- OCR WEBHOOK RAW DATA ---');
                            console.dir(result); // Browser console'da objeyi detaylı görmek için
                            console.log('Stringified:', JSON.stringify(result));

                            // n8n bazen [{json:{...}}] veya {...} döner. 
                            // En içteki anlamlı datayı bulmaya çalışalım.
                            let data = result;
                            if (Array.isArray(data)) data = data[0];
                            if (data && data.json) data = data.json;

                            console.log('--- OCR PROCESSED DATA ---', data);

                            const parsed = { baslik: {}, kimlik: {}, mulkiyet: {} };

                            // Ultra Robust Recursive Search
                            const findDeep = (obj, key) => {
                                if (!obj || typeof obj !== 'object') return null;
                                if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') return obj[key];

                                if (Array.isArray(obj)) {
                                    for (const item of obj) {
                                        const found = findDeep(item, key);
                                        if (found !== null) return found;
                                    }
                                } else {
                                    for (const k in obj) {
                                        if (k === 'pages' || k === 'sections' || k === 'data') { // Önce bildiğimiz dallara bak
                                            const found = findDeep(obj[k], key);
                                            if (found !== null) return found;
                                        }
                                    }
                                    // Bulunamazsa her yeri tara
                                    for (const k in obj) {
                                        if (k !== 'pages' && k !== 'sections' && k !== 'data') {
                                            const found = findDeep(obj[k], key);
                                            if (found !== null) return found;
                                        }
                                    }
                                }
                                return null;
                            };

                            const getV = (key) => findDeep(data, key) || '';

                            parsed.mulkiyet.malik = getV('owner_name') || 'Unknown';
                            parsed.mulkiyet.tarih = getV('signature_date') || getV('transaction_date');
                            parsed.mulkiyet.hisse = getV('share_text');
                            parsed.baslik.bolge = getV('province') || getV('bolge');
                            parsed.baslik.mudurluk = getV('directorate') || getV('office_or_circle');
                            parsed.kimlik.bolge_semt = getV('district') || getV('bolge_semt');
                            parsed.kimlik.parsel_no = getV('property_number') || getV('parsel_no');
                            parsed.kimlik.cins_kisa = getV('property_type') || getV('cins_kisa');
                            parsed.kimlik.aciklama = getV('description') || getV('aciklama');
                            parsed.kimlik.yuzolcumu = getV('area_text');
                            parsed.mulkiyet.yevmiye = getV('daily_register_no');
                            parsed.mulkiyet.islem_turu = getV('transaction_type');

                            console.log('OCR: Eşleşen Veri:', parsed);

                            ocrData.value = parsed;
                            // OCR form verisini de doldur
                            ocrForm.value = {
                                owner_name: parsed.mulkiyet.malik || '',
                                signature_date: parsed.mulkiyet.tarih || '',
                                share_text: parsed.mulkiyet.hisse || '',
                                province: parsed.baslik.bolge || '',
                                district: parsed.kimlik.bolge_semt || '',
                                directorate: parsed.baslik.mudurluk || '',
                                property_number: parsed.kimlik.parsel_no || '',
                                property_type: parsed.kimlik.cins_kisa || '',
                                area_text: parsed.kimlik.yuzolcumu || '',
                                daily_register_no: parsed.mulkiyet.yevmiye || '',
                                transaction_type: parsed.mulkiyet.islem_turu || '',
                                description: parsed.kimlik.aciklama || ''
                            };
                            showSuccess('Başarılı', 'Tapu verisi işlendi.');
                        } else {
                            const errorText = await response.text();
                            console.error('OCR: Webhook hatası:', response.status, errorText);

                            if (errorText.includes('POST requests') || errorText.includes('Method not allowed')) {
                                showSuccess('n8n Ayar Hatası', 'n8n Webhook node\'u "GET" modunda kalmış. Lütfen n8n\'de Webhook node ayarlarını açıp Method\'u "POST" yapın.');
                            } else if (response.status === 404) {
                                console.error("OCR: 404 alındı. Muhtemel neden: /webhook-test URL'si dinlemede değil (n8n'de 'Listen for test event' açık olmalı) veya URL yolu yanlış.");
                                showSuccess('n8n Bağlantı Sorunu', 'Webhook bulunamadı (404). n8n\'de "Listen for test event" butonuna bastınız mı?');
                            }
                            throw new Error(`Webhook hatası: ${response.status} - ${errorText}`);
                        }
                    } catch (error) {
                        console.error("OCR Error:", error);

                        // CORS hatasını kontrol et
                        if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                            console.error('CORS Hatası: n8n webhook\'una CORS header\'ları eklenmeli!');
                            showSuccess('CORS Hatası', 'Webhook\'a erişilemiyor. n8n webhook\'una CORS header\'ları eklenmeli:\n\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: POST\nAccess-Control-Allow-Headers: Content-Type');
                        }

                        console.warn("OCR Error - İşlem durduruldu");
                        showSuccess('Hata', 'OCR işlemi başarısız: ' + error.message);
                    } finally {
                        ocrScanning.value = false;
                    }
                };

                // --- KMZ / KML LOADING ---
                const processFileContent = async (arrayBuffer, isKmz) => {
                    kmzLoading.value = true;
                    loadingMsg.value = isKmz ? 'KMZ Çözülüyor...' : 'KML İşleniyor...';

                    try {
                        let kmlText;
                        if (isKmz) {
                            const zip = await JSZip.loadAsync(arrayBuffer);
                            const kmlFile = Object.keys(zip.files).find(f => f.endsWith('.kml'));
                            if (!kmlFile) throw new Error('KMZ içinde KML dosyası bulunamadı.');
                            kmlText = await zip.files[kmlFile].async('string');
                        } else {
                            kmlText = new TextDecoder().decode(arrayBuffer);
                        }

                        const kmlDom = new DOMParser().parseFromString(kmlText, 'text/xml');
                        const geoJson = toGeoJSON.kml(kmlDom);

                        // Parse properties from GeoJSON - Filter out Points (markers)
                        const filteredFeatures = geoJson.features.filter(f => f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon' || f.geometry.type === 'LineString' || f.geometry.type === 'MultiLineString'));

                        properties.value = filteredFeatures.map((f, index) => {
                            const p = f.properties || {};
                            return {
                                id: p.id || index + 1,
                                ada: p.ada || p.PARSEL_NO?.split('/')[0] || '---',
                                parsel: p.parsel || p.PARSEL_NO?.split('/')[1] || '---',
                                location: p.location || p.MAHALLE || 'Şam / Merkez',
                                type: p.type || p.CINSI || 'Arsa',
                                price: p.price || Math.floor(Math.random() * 500000) + 100000,
                                owner: p.owner || p.AD_SOYAD || 'Meçhul Malik',
                                area: p.area || p.ALAN || '---',
                                geometry: f.geometry
                            };
                        });

                        // Add to map only if map is initialized
                        const rawMap = toRaw(map.value);
                        if (rawMap) {
                            if (geoJsonLayer.value) rawMap.removeLayer(toRaw(geoJsonLayer.value));
                            geoJsonLayer.value = markRaw(L.geoJSON({ type: "FeatureCollection", features: filteredFeatures }, {
                                style: {
                                    color: mapStyle.value.color,
                                    weight: mapStyle.value.weight,
                                    fillOpacity: mapStyle.value.fillOpacity,
                                    fillColor: mapStyle.value.color
                                },
                                onEachFeature: (feature, layer) => {
                                    layer.bindPopup(`<div class="p-3 font-sans text-right" dir="rtl">
                                        <h4 class="font-bold border-b pb-1 mb-2">Parsel: ${feature.properties.ada || '---'}/${feature.properties.parsel || '---'}</h4>
                                        <p class="text-xs mb-1"><b>Malik:</b> ${feature.properties.owner || '---'}</p>
                                        <p class="text-xs"><b>Alan:</b> ${feature.properties.area || '---'} m²</p>
                                    </div>`);
                                }
                            }).addTo(rawMap));

                            const bounds = geoJsonLayer.value.getBounds();
                            if (bounds.isValid()) rawMap.fitBounds(bounds);
                        }

                        showSuccess('Başarılı', `${properties.value.length} parsel yüklendi.`);
                    } catch (err) {
                        console.error('File Error:', err);
                        showSuccess('Hata', 'Dosya işlenemedi: ' + err.message);
                    } finally {
                        kmzLoading.value = false;
                        loadingMsg.value = '';
                    }
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const isKmz = file.name.endsWith('.kmz');
                    const reader = new FileReader();
                    reader.onload = (e) => processFileContent(e.target.result, isKmz);
                    reader.readAsArrayBuffer(file);
                };

                const autoLoadKMZ = async (filename) => {
                    try {
                        console.log(`Otomatik yükleme başlatıldı: ${filename}`);
                        const response = await fetch(filename);
                        if (!response.ok) throw new Error('Dosya sunucuda bulunamadı.');
                        const buffer = await response.arrayBuffer();
                        await processFileContent(buffer, true);
                    } catch (err) {
                        console.warn('Auto-load KMZ failed:', err.message);
                    }
                };

                const openOcrMapModal = () => {
                    modals.value.ocrMap = true;
                    tempSelectedParcel.value = null;
                    nextTick(() => initOcrMap());
                };

                const confirmOcrMapSelection = () => {
                    modals.value.ocrMap = false;
                    showSuccess('Eşleşme Sağlandı', 'Parsel verisi form ile ilişkilendirildi.');
                };

                const saveAndGenerateDeed = () => {
                    // Create a robust property object from OCR form data
                    const newProp = {
                        id: 9999,
                        ada: ocrForm.value.property_number.split('/')[0] || '---',
                        parsel: ocrForm.value.property_number.split('/')[1] || '---',
                        location: (ocrForm.value.province || '---') + ' / ' + (ocrForm.value.district || '---'),
                        directorate: ocrForm.value.directorate || '---',
                        type: ocrForm.value.property_type || '---',
                        area_text: ocrForm.value.area_text || '---',
                        owner_name: ocrForm.value.owner_name || '---',
                        share_text: ocrForm.value.share_text || '---',
                        signature_date: ocrForm.value.signature_date || '---',
                        daily_register_no: ocrForm.value.daily_register_no || '---',
                        transaction_type: ocrForm.value.transaction_type || '---',
                        description: ocrForm.value.description || '---'
                    };

                    modals.value.activeProp = newProp;
                    modals.value.deed = true;
                    showSuccess('Kayıt Başarılı', 'Yeni tapu senedi oluşturuldu.');
                };

                const locateProperty = () => { /* implementation */ }; // simplified

                onMounted(() => {
                    setLang('ar');
                    // Sayfa açıldığında 13.kmz dosyasını otomatik yükle
                    setTimeout(() => autoLoadKMZ('13.kmz'), 1000);
                });

                return {
                    loading, loadingMsg, lang, t, isLoggedIn, loginCreds, loginProcessing, isMobileMenuOpen, loginRole,
                    currentTab, map, searchQuery, properties, modals, toast,
                    ocrImage, ocrScanning, ocrData, ocrForm, tempSelectedParcel, ocrInput,
                    viewerScale, viewerPanX, viewerPanY, viewerMode, isPanning, isSelecting, selectionRect, viewerContainer,
                    handleLogin, changeTab, getIcon, setLang, capitalize,
                    handleOcrUpload, openOcrPicker, handleFileUpload, openOcrMapModal, confirmOcrMapSelection, saveAndGenerateDeed, locateProperty,
                    resetViewer, handleViewerWheel, handleViewerMouseDown, handleViewerMouseMove, handleViewerMouseUp,
                    kmzLoading, mapStyle, showMapSettings
                };
            }
        }).mount('#app');
    </script>
</body>

</html>